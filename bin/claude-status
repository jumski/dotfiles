#!/bin/bash
# Check status of Claude-Neovim integration

CLAUDE_LOCK_DIR="$HOME/.claude/ide"

echo "üîç Claude Code + Neovim Integration Status"
echo "=========================================="

# Check if lock directory exists
if [ ! -d "$CLAUDE_LOCK_DIR" ]; then
    echo "‚ùå No lock directory found at $CLAUDE_LOCK_DIR"
    echo "   ‚Üí Start Neovim and run :ClaudeCode first"
    exit 1
fi

# List active lock files
LOCK_FILES=$(ls "$CLAUDE_LOCK_DIR"/*.lock 2>/dev/null)

if [ -z "$LOCK_FILES" ]; then
    echo "‚ùå No active WebSocket connections"
    echo "   ‚Üí Start Neovim and run :ClaudeCode to create WebSocket server"
else
    echo "‚úÖ Active WebSocket connections:"
    for lock_file in $LOCK_FILES; do
        port=$(basename "$lock_file" .lock)
        echo "   ‚Üí Port: $port"
        
        # Check if port is actually listening
        if netstat -tln 2>/dev/null | grep -q ":$port "; then
            echo "     Status: ‚úÖ Listening"
        else
            echo "     Status: ‚ùå Not listening (stale lock file)"
        fi
    done
fi

echo ""
echo "Environment variables:"
if [ -n "$CLAUDE_IDE_PORT" ]; then
    echo "   CLAUDE_IDE_PORT: $CLAUDE_IDE_PORT"
else
    echo "   CLAUDE_IDE_PORT: (not set)"
fi

if [ -n "$CLAUDE_IDE_HOST" ]; then
    echo "   CLAUDE_IDE_HOST: $CLAUDE_IDE_HOST"
else
    echo "   CLAUDE_IDE_HOST: (not set)"
fi

echo ""
echo "üí° Usage:"
echo "   1. In Neovim: :ClaudeCode"
echo "   2. In tmux: claude-hybrid --continue"
echo "   3. Select code in Neovim and use <leader>as"