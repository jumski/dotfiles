#cloud-config

hostname: {{VM_NAME}}
manage_etc_hosts: true

users:
  - name: jumski
    uid: 1000
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - {{SSH_PUBLIC_KEY}}

package_update: true
package_upgrade: false

packages:
  - avahi-daemon
  - git
  - curl
  - build-essential

runcmd:
  # Enable avahi for mDNS
  - systemctl enable --now avahi-daemon

  # Create mount points
  - mkdir -p /home/jumski/Code
  - mkdir -p /home/jumski/host
  - mkdir -p /mnt/claude-config
  - mkdir -p /home/jumski/.claude
  - mkdir -p /home/jumski/.dotfiles/claude
  - mkdir -p /home/jumski/.opencode
  - chown jumski:jumski /home/jumski/Code /home/jumski/host /home/jumski/.claude /home/jumski/.dotfiles/claude /home/jumski/.opencode

  # Mount virtiofs filesystems (base mounts)
  - mount -t virtiofs code /home/jumski/Code -o ro
  - mount -t virtiofs host /home/jumski/host -o ro
  - mount -t virtiofs claude /mnt/claude-config -o ro
  - mount -t virtiofs dotfiles-claude /home/jumski/.dotfiles/claude -o ro
  - mount -t virtiofs opencode /home/jumski/.opencode -o ro

  # Bind-mount specific claude config items into ~/.claude (read-only)
  # Other subdirs (todos, sessions, memory, debug, projects) remain writable
  - |
    CLAUDE_MOUNT_ITEMS="{{CLAUDE_MOUNT_ITEMS}}"
    for item in $CLAUDE_MOUNT_ITEMS; do
      if [ -n "$item" ]; then
        src="/mnt/claude-config/$item"
        dst="/home/jumski/.claude/$item"
        if [ -e "$src" ]; then
          # Create parent dir if needed
          mkdir -p "$(dirname "$dst")"
          # Bind mount read-only
          mount --bind "$src" "$dst"
          mount -o remount,ro,noload "$dst"
          chown jumski:jumski "$dst"
        fi
      fi
    done

  # Mount writable paths (overlay rw on top of ro Code)
  # WRITABLE_PATHS is a newline-separated list of relative paths under /home/jumski/Code
  - |
    WRITABLE_PATHS="{{WRITABLE_PATHS}}"
    index=0
    echo "$WRITABLE_PATHS" | while IFS= read -r relative_path; do
      if [ -n "$relative_path" ]; then
        full_path="/home/jumski/Code/$relative_path"
        mkdir -p "$full_path"
        mount -t virtiofs "rw_$index" "$full_path"
        chown jumski:jumski "$full_path"
        echo "rw_$index $full_path virtiofs defaults 0 0" >> /etc/fstab
        index=$((index + 1))
      fi
    done

  # Add mounts to fstab for persistence
  - echo 'code /home/jumski/Code virtiofs ro 0 0' >> /etc/fstab
  - echo 'host /home/jumski/host virtiofs ro 0 0' >> /etc/fstab
  - echo 'claude /mnt/claude-config virtiofs ro 0 0' >> /etc/fstab
  - echo 'dotfiles-claude /home/jumski/.dotfiles/claude virtiofs ro 0 0' >> /etc/fstab
  - echo 'opencode /home/jumski/.opencode virtiofs ro 0 0' >> /etc/fstab

  # Install Node.js 24 via nodesource
  - curl -fsSL https://deb.nodesource.com/setup_24.x | bash -
  - apt-get install -y nodejs

  # Install Claude Code globally
  - npm install -g @anthropic-ai/claude-code

  # Add host files sourcing to jumski's profile
  - echo '# Source host-provided secrets and functions' >> /home/jumski/.bashrc
  - echo '[ -f ~/host/secrets.env ] && source ~/host/secrets.env' >> /home/jumski/.bashrc
  - echo '[ -f ~/host/functions.sh ] && source ~/host/functions.sh' >> /home/jumski/.bashrc

write_files:
  - path: /etc/systemd/system/virtiofs-code.mount
    content: |
      [Unit]
      Description=Mount virtiofs Code share (read-only)
      After=local-fs.target

      [Mount]
      What=code
      Where=/home/jumski/Code
      Type=virtiofs
      Options=ro

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/virtiofs-host.mount
    content: |
      [Unit]
      Description=Mount virtiofs host share (secrets, functions)
      After=local-fs.target

      [Mount]
      What=host
      Where=/home/jumski/host
      Type=virtiofs
      Options=ro

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/virtiofs-claude.mount
    content: |
      [Unit]
      Description=Mount virtiofs claude config share (staging)
      After=local-fs.target

      [Mount]
      What=claude
      Where=/mnt/claude-config
      Type=virtiofs
      Options=ro

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/virtiofs-dotfiles-claude.mount
    content: |
      [Unit]
      Description=Mount virtiofs dotfiles claude share (symlink target)
      After=local-fs.target

      [Mount]
      What=dotfiles-claude
      Where=/home/jumski/.dotfiles/claude
      Type=virtiofs
      Options=ro

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/virtiofs-opencode.mount
    content: |
      [Unit]
      Description=Mount virtiofs opencode config share
      After=local-fs.target

      [Mount]
      What=opencode
      Where=/home/jumski/.opencode
      Type=virtiofs
      Options=ro

      [Install]
      WantedBy=multi-user.target

final_message: "VMW instance {{VM_NAME}} ready after $UPTIME seconds"
