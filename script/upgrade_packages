#!/bin/bash

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
RESET='\033[0m'

# Find all packages defined in dotfiles
pacman_packages=$(find . -name packages.pacman -exec cat {} \; | grep -v '^#' | grep -v '^$' | sort -u | tr '\n' ' ')
aur_packages=$(find . -name packages.aur -exec cat {} \; | grep -v '^#' | grep -v '^$' | sort -u | tr '\n' ' ')

# Get list of outdated packages
outdated_list=$(pamac checkupdates 2>/dev/null || true)

# Check if there are system-wide updates available
total_updates=$(echo "$outdated_list" | grep -c "^.*->.*" || echo "0")

# Arrays to store outdated packages
outdated_pacman=()
outdated_aur=()

# Check pacman packages
for pkg in $pacman_packages; do
    if echo "$outdated_list" | grep -q "^$pkg "; then
        outdated_pacman+=("$pkg")
    fi
done

# Check AUR packages
for pkg in $aur_packages; do
    if echo "$outdated_list" | grep -q "^$pkg "; then
        outdated_aur+=("$pkg")
    fi
done

# Calculate dotfiles package count
dotfiles_updates=$((${#outdated_pacman[@]} + ${#outdated_aur[@]}))

# Check if there are system updates beyond dotfiles packages
if [ "$total_updates" -gt 0 ] && [ "$total_updates" -gt "$dotfiles_updates" ]; then
    other_updates=$((total_updates - dotfiles_updates))

    echo -e "${RED}════════════════════════════════════════════════════════════════${RESET}"
    echo -e "${RED}ERROR: Full system upgrade required first!${RESET}"
    echo -e "${RED}════════════════════════════════════════════════════════════════${RESET}"
    echo
    echo -e "${YELLOW}System Status:${RESET}"
    echo -e "  Total updates available: ${RED}${total_updates}${RESET}"
    echo -e "  Dotfiles packages:       ${BLUE}${dotfiles_updates}${RESET}"
    echo -e "  Other packages:          ${RED}${other_updates}${RESET}"
    echo
    echo -e "${YELLOW}Why this matters:${RESET}"
    echo "  On rolling-release systems (Arch/Manjaro), partial upgrades can"
    echo "  break your system due to incompatible library versions."
    echo
    echo -e "${GREEN}What to do:${RESET}"
    echo -e "  1. Perform a full system upgrade first:"
    echo -e "     ${BLUE}sudo pamac upgrade${RESET}"
    echo
    echo -e "  2. Reboot your system:"
    echo -e "     ${BLUE}sudo reboot${RESET}"
    echo
    echo -e "  3. Then upgrade dotfiles packages:"
    echo -e "     ${BLUE}make upgrade${RESET}"
    echo
    echo -e "${YELLOW}For detailed upgrade procedure, see:${RESET}"
    echo -e "  ~/SynologyDrive/Areas/Dev/manjaro-$(hostname)/system-upgrade-procedure.md"
    echo
    exit 1
fi

# Upgrade packages
if [ ${#outdated_pacman[@]} -gt 0 ]; then
    echo -e "${BLUE}Upgrading pacman packages...${RESET}"
    # Use -Syu to properly handle replacements and conflicts
    sudo pacman -S --noconfirm --needed "${outdated_pacman[@]}"
fi

if [ ${#outdated_aur[@]} -gt 0 ]; then
    echo -e "${BLUE}Upgrading AUR packages...${RESET}"
    pamac build --no-confirm "${outdated_aur[@]}"
fi

if [ ${#outdated_pacman[@]} -eq 0 ] && [ ${#outdated_aur[@]} -eq 0 ]; then
    echo -e "${GREEN}All dotfile packages are already up to date!${RESET}"
else
    echo -e "${GREEN}Upgrade complete!${RESET}"
fi
