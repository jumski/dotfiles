#!/bin/bash

# ALWAYS_FOCUS_TERMINAL - When set to "1", skip toggling and always focus terminal.
# Useful for dictation workflows where you always want to return to terminal.
# Example: ALWAYS_FOCUS_TERMINAL=1 toggle_window_focus
ALWAYS_FOCUS_TERMINAL=0

if [ "$ALWAYS_FOCUS_TERMINAL" = "1" ]; then
  # Source helper for smart Kitty window detection (remote > local > any)
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  source "$(dirname "$SCRIPT_DIR")/focus-toggler/find_kitty_window.sh"
  terminal=$(find_kitty_window)
  if [ -n "$terminal" ]; then
    dotool windowactivate "$terminal"
  fi
  exit 0
fi

# Path to mode configuration file
MODE_FILE="$HOME/.config/window-focus-mode"

# Read mode from file, default to 'activities' if file doesn't exist or is empty
if [ -f "$MODE_FILE" ]; then
  MODE=$(cat "$MODE_FILE" | tr -d '[:space:]')
fi

# Default to 'kitties' if MODE is empty
if [ -z "$MODE" ]; then
  MODE="kitties"
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FOCUS_TOGGLER_DIR="$(dirname "$SCRIPT_DIR")/focus-toggler"

# Dispatch to the appropriate script based on mode
case "$MODE" in
  activities)
    exec "$FOCUS_TOGGLER_DIR/toggle_activities.sh"
    ;;
  windows)
    exec "$FOCUS_TOGGLER_DIR/toggle_windows.sh"
    ;;
  kitties)
    exec "$FOCUS_TOGGLER_DIR/toggle_kitties.sh"
    ;;
  *)
    echo "Error: Unknown mode '$MODE'. Defaulting to 'activities'."
    exec "$FOCUS_TOGGLER_DIR/toggle_activities.sh"
    ;;
esac
