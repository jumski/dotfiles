#!/bin/bash

set -e # Exit with nonzero exit code if anything fails

# Get the current date in YYYY-MM-DD format
current_date=$(date +%F)

# Ask for confirmation before pushing to staging
read -p "Are you sure you want to deploy to staging? (y/n) " confirm
if [ "$confirm" != "y" ]; then
    echo "Deployment to staging aborted."
    exit 1
fi

# Stash any uncommitted changes
git add .
git stash save "before staging deploy"

# Switch to the main branch and pull latest changes
git checkout main
git pull

# Create a new demo branch with today's date
new_branch="demo/$current_date"
git checkout -b "$new_branch"

# Push changes to Heroku staging environment
git push heroku-staging "$new_branch":master --force-with-lease

# Run database migrations
heroku run --app toolchest-staging bin/rails db:migrate db:migrate:status
